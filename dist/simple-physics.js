(function() {(function(h){function b(a){return function(b){var e=b.x>>a,c=b.x+b.width>>a,f=b.y+b.height>>a,g,h=[];for(g=b.y>>a;g<=f;g++)for(b=e;b<=c;b++)h.push(""+b+":"+g);return h}}function a(a){a||(a=5);this.getKeys=b(a);this.hash={};this.list=[];this._lastTotalCleared=0}a.prototype.clear=function(){for(var a in this.hash)0===this.hash[a].length?delete this.hash[a]:this.hash[a].length=0;this.list.length=0};a.prototype.getNumBuckets=function(){var a,b=0;for(a in this.hash)this.hash.hasOwnProperty(a)&&0<this.hash[a].length&&
b++;return b};a.prototype.insert=function(a,b){var e=this.getKeys(b||a),c,f;this.list.push(a);for(f=0;f<e.length;f++)c=e[f],this.hash[c]?this.hash[c].push(a):this.hash[c]=[a]};a.prototype.retrieve=function(a,b){var e=[],c,f,g;if(!a&&!b)return this.list;c=this.getKeys(b||a);for(f=0;f<c.length;f++)g=c[f],this.hash[g]&&(e=e.concat(this.hash[g]));return e};"undefined"!==typeof module&&module.exports?module.exports=a:h.SpatialHash=a})(this);(function(h){function b(a,b){"undefined"===typeof a&&(a=0);"undefined"===typeof b&&(b=0);this.x=a;this.y=b}b.prototype.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};b.prototype.getLength2=function(){return this.x*this.x+this.y*this.y};b.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};b.prototype.subtract=function(a){this.x-=a.x;this.y-=a.y;return this};b.prototype.normalize=function(){var a=this.getLength();0!=a&&(this.x/=a,this.y/=a);return this};b.prototype.scale=
function(a){this.x*=a;this.y*=a;return this};b.prototype.scaleDown=function(a){if(0!=a){var b=this.getLength();this.x/=b;this.y/=b;a=b-a;0>a&&(a=0);this.x*=a;this.y*=a;return this}};b.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y};b.prototype.copy=function(){return new b(this.x,this.y)};"undefined"!==typeof module&&module.exports?module.exports=b:h.SimpleVector=b})(this);"undefined"!==typeof module&&module.exports&&(SimpleVector=require("./SimpleVector"));
(function(h){function b(a){this.IGNORED_COLLISION_LAYER=-1;this.DEFAULT_COLLISION_LAYER=0;"undefined"===typeof a&&(a={});"undefined"===typeof a.mass&&(a.mass=1);"undefined"===typeof a.radius&&(a.radius=1);"undefined"===typeof a.position&&(a.position=new SimpleVector(0,0));"undefined"===typeof a.velocity&&(a.velocity=new SimpleVector(0,0));"undefined"===typeof a.maxSpeed&&(a.maxSpeed=0);"undefined"===typeof a.collisionLayer&&(a.collisionLayer=this.DEFAULT_COLLISION_LAYER);"undefined"===typeof a.isTrigger&&
(a.isTrigger=!1);this._mass=a.mass;this._radius=a.radius;this._position=a.position;this._velocity=a.velocity;this._force=new SimpleVector(0,0);this._collides=!1;this._maxSpeed=a.maxSpeed;this._maxSpeed2=a.maxSpeed*a.maxSpeed;this._customData=a.customData;this._collisionLayer=a.collisionLayer;this._isTrigger=a.isTrigger;this._invMass=0<this._mass?1/this._mass:0;this._contactPoint=new SimpleVector(0,0);this._linearDrag=-1}b.prototype.getMass=function(){return this._mass};b.prototype.getInvMass=function(){return this._invMass};
b.prototype.setMass=function(a){this._mass=a;this._invMass=0<this._mass?1/this._mass:0};b.prototype.getRadius=function(){return this._radius};b.prototype.setRadius=function(a){this._radius=a};b.prototype.getLinearDrag=function(){return this._linearDrag};b.prototype.setLinearDrag=function(a){this._linearDrag=a};b.prototype.getCollisionLayer=function(){return this._collisionLayer};b.prototype.setCollisionLayer=function(a){this._collisionLayer=a};b.prototype.getPosition=function(){return this._position};
b.prototype.setPosition=function(a){this._position=a};b.prototype.getVelocity=function(){return this._velocity};b.prototype.setVelocity=function(a){this._velocity=a};b.prototype.applyForce=function(a){this._force.add(a)};b.prototype.getForce=function(){return this._force};b.prototype.checkCollision=function(a){if(this.getCollisionLayer()!=a.getCollisionLayer())return!1;var b=this._position.x-this._radius,d=this._position.y-this._radius,e=a._position.x+a._radius,c=a._position.y+a._radius;if(this._position.x+
this._radius<a._position.x-a._radius||b>e||this._position.y+this._radius<a._position.y-a._radius||d>c)return!1;b=this._radius+a._radius;b*=b;a=new SimpleVector(this._position.x-a._position.x,this._position.y-a._position.y);if(a.getLength2()<b)return a.normalize(),this._contactPoint.x=this._position.x-a.x*this._radius,this._contactPoint.y=this._position.y-a.y*this._radius,!0;this._contactPoint.x=0;this._contactPoint.y=0;return!1};b.prototype.getContactPoint=function(){return this._contactPoint};b.prototype.setCollidesFlag=
function(a){this._collides=a};b.prototype.collides=function(){return this._collides};b.prototype.getRect=function(){var a=2*this._radius;return{x:this._position.x-this._radius,y:this._position.y-this._radius,width:a,height:a}};b.prototype.setMaxSpeed=function(a){this._maxSpeed=a;this._maxSpeed2=a*a};b.prototype.getMaxSpeed=function(){return this._maxSpeed};b.prototype.getMaxSpeed2=function(){return this._maxSpeed2};b.prototype.isTrigger=function(){return this._isTrigger};b.prototype.setCustomData=
function(a){this._customData=a};b.prototype.getCustomData=function(){return this._customData};"undefined"!==typeof module&&module.exports?module.exports=b:h.SimpleBody=b})(this);"undefined"!==typeof module&&module.exports&&(SimpleVector=require("./SimpleVector"),SimpleBody=require("./SimpleBody"),SpatialHash=require("../third_party/spatialhash"));
(function(h){function b(a){"undefined"===typeof a&&(a={});"undefined"===typeof a.fixedStep&&(a.fixedStep=.03);"undefined"===typeof a.linearDrag&&(a.linearDrag=10);"undefined"===typeof a.size&&(a.size=100);"undefined"===typeof a.gravity&&(a.gravity=new SimpleVector(0,0));this._fixedStep=a.fixedStep;this._linearDrag=a.linearDrag;this.calculateInstantLinearDrag();this._bodyList=[];this._worldSize=a.size;this.EPSILON=1E-6;this._collisionListener=[];this._tickId=0;this._gravity=a.gravity;this._spatialHash=
new SpatialHash}b.prototype.init=function(){return!0};b.prototype.getWorldSize=function(){return this._worldSize};b.prototype.getGravity=function(){return this._gravity};b.prototype.setGravity=function(a){this._gravity=a};b.prototype.increaseTickId=function(){this._tickId++;255<this._tickId&&(this._tickId=0)};b.prototype.getTickId=function(){return this._tickId};b.prototype.calculateInstantLinearDrag=function(){this._instantLinearDrag=this._linearDrag*this._fixedStep};b.prototype.registerCollisionListener=
function(a){this._collisionListener.push(a)};b.prototype.deregisterCollisionListener=function(a){var b=!1;a=this._collisionListener.indexOf(a);-1<a&&(this._collisionListener.splice(a,1),b=!0);return b};b.prototype.buildSpatialHash=function(){this._spatialHash.clear();for(var a=this._bodyList.length,b=0;b<a;b++){var d=this._bodyList[b];0<=d.getCollisionLayer()&&this._spatialHash.insert(d,d.getRect())}};b.prototype.getFixedStep=function(){return this._fixedStep};b.prototype.setFixedStep=function(a){this._fixedStep=
a;this.calculateInstantLinearDrag()};b.prototype.getLinearDrag=function(){return this._linearDrag};b.prototype.setLinearDrag=function(a){this._linearDrag=a;this.calculateInstantLinearDrag()};b.prototype.getBodyList=function(){return this._bodyList};b.prototype.createBody=function(a){a=new SimpleBody(a);this._bodyList.push(a);return a};b.prototype.removeBody=function(a){var b=!1;a=this._bodyList.indexOf(a);-1<a&&(this._bodyList.splice(a,1),b=!0);return b};b.prototype.removeAllBodies=function(){this._bodyList=
[]};b.prototype.runStep=function(){for(var a=this._bodyList.length,b=0;b<a;b++){var d=this._bodyList[b];d.setCollidesFlag(!1);this.iterateBody(d)}this.buildSpatialHash();for(var a=this._bodyList.length,e=this._collisionListener.length,b=a-1;-1<b;b--)if(d=this._bodyList[b],void 0!=d)for(var a=this._spatialHash.retrieve(d.getRect()),c=a.length,f=0;f<c;f++){var g=a[f];if(d!=g&&d.checkCollision(g)){d.setCollidesFlag(!0);g.setCollidesFlag(!0);0==d.isTrigger()&&0==g.isTrigger()&&this.resolveCollision(d,
g);for(var h=0;h<e;h++)this._collisionListener[h].onCollision(d,g,d.getContactPoint())}}a=this._bodyList.length;for(b=0;b<a;b++)d=this._bodyList[b],0==d.isTrigger()&&this.worldBoundaryCheck(d);this.increaseTickId()};b.prototype.iterateBody=function(a){var b=a.getMass();if(!(b<this.EPSILON)){var d=a.getPosition(),e=a.getVelocity(),c=a.getForce();Math.abs(this._gravity.x)>this.EPSILON&&(c.x+=this._gravity.x*b);Math.abs(this._gravity.y)>this.EPSILON&&(c.y+=this._gravity.y*b);Math.abs(c.x)>this.EPSILON&&
(e.x+=c.x/b);Math.abs(c.y)>this.EPSILON&&(e.y+=c.y/b);b=a.getMaxSpeed();if(b>this.EPSILON){var f=a.getMaxSpeed2(),g=e.getLength2();g>f&&(f=Math.sqrt(g),e.x=b*e.x/f,e.y=b*e.y/f)}b=!1;Math.abs(e.x)>this.EPSILON&&(d.x+=e.x*this._fixedStep,b=!0);Math.abs(e.y)>this.EPSILON&&(d.y+=e.y*this._fixedStep,b=!0);b&&(a=a.getLinearDrag(),0>a?e.scaleDown(this._instantLinearDrag):e.scaleDown(a*this._fixedStep));c.x=0;c.y=0}};b.prototype.resolveCollision=function(a,b){var d=b.getPosition().copy().subtract(a.getPosition()),
e=d.copy().normalize(),c=b.getVelocity().copy().subtract(a.getVelocity()).dotProduct(e);if(c<this.EPSILON){var c=-1.4*c/(a.getInvMass()+b.getInvMass()),c=e.copy().scale(c),f=a.getVelocity(),g=b.getVelocity();f.x-=c.x*a.getInvMass();f.y-=c.y*a.getInvMass();g.x+=c.x*b.getInvMass();g.y+=c.y*b.getInvMass()}d=a.getRadius()+b.getRadius()-d.getLength();c=Math.max(d-.01,0)/(a.getInvMass()+b.getInvMass())*.2;d=c*e.x;e=c*e.y;c=a.getPosition();f=b.getPosition();c.x-=a.getInvMass()*d;c.y-=a.getInvMass()*e;f.x+=
b.getInvMass()*d;f.y+=b.getInvMass()*e};b.prototype.worldBoundaryCheck=function(a){var b=a.getPosition(),d=a.getVelocity();a=a.getRadius();var e=b.x+a,c=b.y-a,f=b.y+a;b.x-a<-this._worldSize&&(b.x=-this._worldSize+a,d.x=.5*Math.abs(d.x));e>this._worldSize&&(b.x=this._worldSize-a,d.x=.5*-Math.abs(d.x));c<-this._worldSize&&(b.y=-this._worldSize+a,d.y=.5*Math.abs(d.y));f>this._worldSize&&(b.y=this._worldSize-a,d.y=.5*-Math.abs(d.y))};"undefined"!==typeof module&&module.exports?module.exports=b:h.SimplePhysics=
b})(this);}).call(window);
